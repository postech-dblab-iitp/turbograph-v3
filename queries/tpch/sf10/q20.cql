MATCH (n:NATION)<-[:SUPP_BELONG_TO]-(s:SUPPLIER)<-[:SUPPLIED_BY]-(li:LINEITEM)-[:COMPOSED_BY]->(p:PART),
    (p)-[ps:PARTSUPP]->(s)
WHERE n.N_NAME = 'JAPAN' AND li.L_SHIPDATE >= date('1996-01-01')
    AND li.L_SHIPDATE < date('1997-01-01')
    AND PREFIX(p.P_NAME,'lace')
WITH ps._id AS PSID, ps.PS_AVAILQTY AS PS_AVAILQTY, s._id AS SID, s.S_NAME AS S_NAME, s.S_ADDRESS AS S_ADDRESS, sum(li.L_QUANTITY) as prev_quantity_sum
WITH PS_AVAILQTY, S_NAME, S_ADDRESS, 0.5 * prev_quantity_sum AS quantity_sum
WHERE PS_AVAILQTY > quantity_sum
RETURN DISTINCT S_NAME, S_ADDRESS
ORDER BY S_NAME;